include:
  - project: $CATALOG_PATH
    file:
      - vault-ci.yml
    ref: main

cache:
  paths:
    - node_modules

variables:
  TAG: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
  REGISTRY_URL: "${IMAGE_REPOSITORY}"

stages:
  - read-secret
  - build-images

read_secret:
  stage: read-secret
  extends:
    - .vault:read_secret

build-backend:
  variables:
    WORKING_DIR: "."
    DOCKERFILE: packages/backend/Dockerfile
    IMAGE_NAME: backend
  stage: build-images
  extends:
    - .kaniko:simple-build-push

build-migrations:
  variables:
    WORKING_DIR: packages/migrations
    DOCKERFILE: Dockerfile
    IMAGE_NAME: migrations
  stage: build-images
  extends:
    - .kaniko:simple-build-push

build-frontend-usagers:
  variables:
    WORKING_DIR: "."
    DOCKERFILE: packages/frontend-usagers/Dockerfile
    IMAGE_NAME: frontend-usagers
    SENTRY_PROJECT: "vao-usagers"
  stage: build-images
  extends:
    - .kaniko:simple-build-push

build-frontend-bo:
  variables:
    WORKING_DIR: "."
    DOCKERFILE: packages/frontend-bo/Dockerfile
    IMAGE_NAME: frontend-bo
    SENTRY_PROJECT: "vao-admin"
  stage: build-images
  extends:
    - .kaniko:simple-build-push


.kaniko:simple-build-push:
  variables:
    DOCKERFILE: Dockerfile
    WORKING_DIR: .
    IMAGE_NAME: ""
    SENTRY_PROJECT: ""
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    # CA
    - if [ ! -z $CA_BUNDLE ]; then cat $CA_BUNDLE >> /kaniko/ssl/certs/additional-ca-cert-bundle.crt; fi
    - mkdir -p /kaniko/.docker
    - echo "$DOCKER_AUTH" > /kaniko/.docker/config.json
    - echo "$SENTRY_AUTH_TOKEN" > /kaniko/sentry_auth_token
    - /kaniko/executor --build-arg http_proxy=$http_proxy
      --build-arg https_proxy=$https_proxy
      --build-arg no_proxy=$no_proxy
      --build-arg SENTRY_URL="https://sentry.fabrique.social.gouv.fr"
      --build-arg SENTRY_ORG="incubateur"
      --build-arg SENTRY_PROJECT="$SENTRY_PROJECT"
      --build-arg SENTRY_AUTH_TOKEN="$SENTRY_AUTH_TOKEN"
      --build-arg SENTRY_RELEASE="$TAG"
      --context="$CI_PROJECT_DIR/$WORKING_DIR"
      --dockerfile="$CI_PROJECT_DIR/$WORKING_DIR/$DOCKERFILE"
      --registry-mirror=nexus-docker-proxy.apps.c6.numerique-interieur.com 
      --destination $REGISTRY_URL/$IMAGE_NAME:$TAG

